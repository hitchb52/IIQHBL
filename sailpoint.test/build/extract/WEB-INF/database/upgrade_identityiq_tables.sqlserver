--
-- This script contains DDL statements to upgrade a database schema to
-- reflect changes to the model.  This file should only be used to
-- upgrade from the last formal release version to the current code base.
--
-- The CONTEXT-SWITCH token is used to notify the upgrader of a change in database context. The token is from
-- the iiq.properties file which represents the database url.
--

USE identityiq
GO

-- DO NOT REMOVE OR MODIFY BLOCK
-- CONTEXT-SWITCH: dataSource
-- DO NOT REMOVE OR MODIFY BLOCK

--
-- add new significant_modified column
--

alter table identityiq.spt_account_group add significant_modified numeric(19,0);
GO
alter table identityiq.spt_activity_constraint add significant_modified numeric(19,0);
GO
alter table identityiq.spt_activity_data_source add significant_modified numeric(19,0);
GO
alter table identityiq.spt_alert add significant_modified numeric(19,0);
GO
alter table identityiq.spt_alert_action add significant_modified numeric(19,0);
GO
alter table identityiq.spt_alert_definition add significant_modified numeric(19,0);
GO
alter table identityiq.spt_application add significant_modified numeric(19,0);
GO
alter table identityiq.spt_application_schema add significant_modified numeric(19,0);
GO
alter table identityiq.spt_application_scorecard add significant_modified numeric(19,0);
GO
alter table identityiq.spt_attachment add significant_modified numeric(19,0);
GO
alter table identityiq.spt_audit_config add significant_modified numeric(19,0);
GO
alter table identityiq.spt_audit_event add significant_modified numeric(19,0);
GO
alter table identityiq.spt_authentication_answer add significant_modified numeric(19,0);
GO
alter table identityiq.spt_authentication_question add significant_modified numeric(19,0);
GO
alter table identityiq.spt_batch_request add significant_modified numeric(19,0);
GO
alter table identityiq.spt_batch_request_item add significant_modified numeric(19,0);
GO
alter table identityiq.spt_bulk_id_join add significant_modified numeric(19,0);
GO
alter table identityiq.spt_bundle add significant_modified numeric(19,0);
GO
alter table identityiq.spt_bundle_archive add significant_modified numeric(19,0);
GO
alter table identityiq.spt_bundle_profile_relation add significant_modified numeric(19,0);
GO
alter table identityiq.spt_bundle_profile_relation_object add significant_modified numeric(19,0);
GO
alter table identityiq.spt_bundle_profile_relation_step add significant_modified numeric(19,0);
GO
alter table identityiq.spt_capability add significant_modified numeric(19,0);
GO
alter table identityiq.spt_category add significant_modified numeric(19,0);
GO
alter table identityiq.spt_certification add significant_modified numeric(19,0);
GO
alter table identityiq.spt_certification_action add significant_modified numeric(19,0);
GO
alter table identityiq.spt_certification_archive add significant_modified numeric(19,0);
GO
alter table identityiq.spt_certification_challenge add significant_modified numeric(19,0);
GO
alter table identityiq.spt_certification_definition add significant_modified numeric(19,0);
GO
alter table identityiq.spt_certification_delegation add significant_modified numeric(19,0);
GO
alter table identityiq.spt_certification_entity add significant_modified numeric(19,0);
GO
alter table identityiq.spt_certification_group add significant_modified numeric(19,0);
GO
alter table identityiq.spt_certification_item add significant_modified numeric(19,0);
GO
alter table identityiq.spt_classification add significant_modified numeric(19,0);
GO
alter table identityiq.spt_cloud_access3way add significant_modified numeric(19,0);
GO
alter table identityiq.spt_cloud_access_group add significant_modified numeric(19,0);
GO
alter table identityiq.spt_cloud_access_role add significant_modified numeric(19,0);
GO
alter table identityiq.spt_cloud_access_scope add significant_modified numeric(19,0);
GO
alter table identityiq.spt_configuration add significant_modified numeric(19,0);
GO
alter table identityiq.spt_correlation_config add significant_modified numeric(19,0);
GO
alter table identityiq.spt_custom add significant_modified numeric(19,0);
GO
alter table identityiq.spt_deleted_object add significant_modified numeric(19,0);
GO
alter table identityiq.spt_dictionary add significant_modified numeric(19,0);
GO
alter table identityiq.spt_dictionary_term add significant_modified numeric(19,0);
GO
alter table identityiq.spt_dynamic_scope add significant_modified numeric(19,0);
GO
alter table identityiq.spt_email_template add significant_modified numeric(19,0);
GO
alter table identityiq.spt_entitlement_group add significant_modified numeric(19,0);
GO
alter table identityiq.spt_file_bucket add significant_modified numeric(19,0);
GO
alter table identityiq.spt_form add significant_modified numeric(19,0);
GO
alter table identityiq.spt_full_text_index add significant_modified numeric(19,0);
GO
alter table identityiq.spt_generic_constraint add significant_modified numeric(19,0);
GO
alter table identityiq.spt_group_definition add significant_modified numeric(19,0);
GO
alter table identityiq.spt_group_factory add significant_modified numeric(19,0);
GO
alter table identityiq.spt_group_index add significant_modified numeric(19,0);
GO
alter table identityiq.spt_identity add significant_modified numeric(19,0);
GO
alter table identityiq.spt_identity_archive add significant_modified numeric(19,0);
GO
alter table identityiq.spt_identity_entitlement add significant_modified numeric(19,0);
GO
alter table identityiq.spt_identity_history_item add significant_modified numeric(19,0);
GO
alter table identityiq.spt_identity_request add significant_modified numeric(19,0);
GO
alter table identityiq.spt_identity_request_item add significant_modified numeric(19,0);
GO
alter table identityiq.spt_identity_snapshot add significant_modified numeric(19,0);
GO
alter table identityiq.spt_identity_trigger add significant_modified numeric(19,0);
GO
alter table identityiq.spt_integration_config add significant_modified numeric(19,0);
GO
alter table identityiq.spt_jasper_page_bucket add significant_modified numeric(19,0);
GO
alter table identityiq.spt_jasper_result add significant_modified numeric(19,0);
GO
alter table identityiq.spt_jasper_template add significant_modified numeric(19,0);
GO
alter table identityiq.spt_link add significant_modified numeric(19,0);
GO
alter table identityiq.spt_localized_attribute add significant_modified numeric(19,0);
GO
alter table identityiq.spt_managed_attribute add significant_modified numeric(19,0);
GO
alter table identityiq.spt_message_template add significant_modified numeric(19,0);
GO
alter table identityiq.spt_mining_config add significant_modified numeric(19,0);
GO
alter table identityiq.spt_mitigation_expiration add significant_modified numeric(19,0);
GO
alter table identityiq.spt_module add significant_modified numeric(19,0);
GO
alter table identityiq.spt_monitoring_statistic add significant_modified numeric(19,0);
GO
alter table identityiq.spt_native_identity_change_event add significant_modified numeric(19,0);
GO
alter table identityiq.spt_object_classification add significant_modified numeric(19,0);
GO
alter table identityiq.spt_object_config add significant_modified numeric(19,0);
GO
alter table identityiq.spt_partition_result add significant_modified numeric(19,0);
GO
alter table identityiq.spt_password_policy add significant_modified numeric(19,0);
GO
alter table identityiq.spt_password_policy_holder add significant_modified numeric(19,0);
GO
alter table identityiq.spt_persisted_file add significant_modified numeric(19,0);
GO
alter table identityiq.spt_plugin add significant_modified numeric(19,0);
GO
alter table identityiq.spt_policy add significant_modified numeric(19,0);
GO
alter table identityiq.spt_policy_violation add significant_modified numeric(19,0);
GO
alter table identityiq.spt_post_commit_notification_object add significant_modified numeric(19,0);
GO
alter table identityiq.spt_process_log add significant_modified numeric(19,0);
GO
alter table identityiq.spt_profile add significant_modified numeric(19,0);
GO
alter table identityiq.spt_provisioning_request add significant_modified numeric(19,0);
GO
alter table identityiq.spt_provisioning_transaction add significant_modified numeric(19,0);
GO
alter table identityiq.spt_quick_link add significant_modified numeric(19,0);
GO
alter table identityiq.spt_quick_link_options add significant_modified numeric(19,0);
GO
alter table identityiq.spt_recommender_definition add significant_modified numeric(19,0);
GO
alter table identityiq.spt_remediation_item add significant_modified numeric(19,0);
GO
alter table identityiq.spt_remote_login_token add significant_modified numeric(19,0);
GO
alter table identityiq.spt_request add significant_modified numeric(19,0);
GO
alter table identityiq.spt_request_definition add significant_modified numeric(19,0);
GO
alter table identityiq.spt_request_state add significant_modified numeric(19,0);
GO
alter table identityiq.spt_resource_event add significant_modified numeric(19,0);
GO
alter table identityiq.spt_right_config add significant_modified numeric(19,0);
GO
alter table identityiq.spt_role_index add significant_modified numeric(19,0);
GO
alter table identityiq.spt_role_metadata add significant_modified numeric(19,0);
GO
alter table identityiq.spt_role_mining_result add significant_modified numeric(19,0);
GO
alter table identityiq.spt_role_scorecard add significant_modified numeric(19,0);
GO
alter table identityiq.spt_rule add significant_modified numeric(19,0);
GO
alter table identityiq.spt_rule_registry add significant_modified numeric(19,0);
GO
alter table identityiq.spt_scope add significant_modified numeric(19,0);
GO
alter table identityiq.spt_scorecard add significant_modified numeric(19,0);
GO
alter table identityiq.spt_score_config add significant_modified numeric(19,0);
GO
alter table identityiq.spt_server add significant_modified numeric(19,0);
GO
alter table identityiq.spt_server_statistic add significant_modified numeric(19,0);
GO
alter table identityiq.spt_service_definition add significant_modified numeric(19,0);
GO
alter table identityiq.spt_service_lock add significant_modified numeric(19,0);
GO
alter table identityiq.spt_service_status add significant_modified numeric(19,0);
GO
alter table identityiq.spt_sign_off_history add significant_modified numeric(19,0);
GO
alter table identityiq.spt_sodconstraint add significant_modified numeric(19,0);
GO
alter table identityiq.spt_archived_cert_entity add significant_modified numeric(19,0);
GO
alter table identityiq.spt_archived_cert_item add significant_modified numeric(19,0);
GO
alter table identityiq.spt_pending_req_attach add significant_modified numeric(19,0);
GO
alter table identityiq.spt_right add significant_modified numeric(19,0);
GO
alter table identityiq.spt_tag add significant_modified numeric(19,0);
GO
alter table identityiq.spt_target add significant_modified numeric(19,0);
GO
alter table identityiq.spt_target_association add significant_modified numeric(19,0);
GO
alter table identityiq.spt_target_source add significant_modified numeric(19,0);
GO
alter table identityiq.spt_task_definition add significant_modified numeric(19,0);
GO
alter table identityiq.spt_task_event add significant_modified numeric(19,0);
GO
alter table identityiq.spt_task_result add significant_modified numeric(19,0);
GO
alter table identityiq.spt_time_period add significant_modified numeric(19,0);
GO
alter table identityiq.spt_uiconfig add significant_modified numeric(19,0);
GO
alter table identityiq.spt_uipreferences add significant_modified numeric(19,0);
GO
alter table identityiq.spt_widget add significant_modified numeric(19,0);
GO
alter table identityiq.spt_workflow add significant_modified numeric(19,0);
GO
alter table identityiq.spt_workflow_case add significant_modified numeric(19,0);
GO
alter table identityiq.spt_workflow_registry add significant_modified numeric(19,0);
GO
alter table identityiq.spt_workflow_target add significant_modified numeric(19,0);
GO
alter table identityiq.spt_workflow_test_suite add significant_modified numeric(19,0);
GO
alter table identityiq.spt_work_item add significant_modified numeric(19,0);
GO
alter table identityiq.spt_work_item_archive add significant_modified numeric(19,0);
GO
alter table identityiq.spt_work_item_config add significant_modified numeric(19,0);
GO


create table identityiq.spt_intercepted_delete (
     id nvarchar(32) not null,
     created numeric(19,0),
     modified numeric(19,0),
     significant_modified numeric(19,0),
     object_id nvarchar(32) not null,
     object_name nvarchar(128),
     object_type nvarchar(128) not null,
     object_created_date numeric(19,0),
     object_deleted_date numeric(19,0) not null,
     extract_config_name nvarchar(255) not null,
     transform_config_name nvarchar(255) not null,
     extract_execution_time_ms numeric(19,0),
     extracted_object_json nvarchar(max) not null,
     primary key (id)
);
GO

-- Add subtype column to post commit notification object
alter table identityiq.spt_post_commit_notification_object add subtype nvarchar(256);
GO

alter table identityiq.spt_task_result add sequential_monitor_id nvarchar(32);
GO

-- Adding service type to service definition table.
alter table identityiq.spt_service_definition add service_type nvarchar(255) default 'DEFAULT' not null;
GO

-- Adding YAMLConfig table
create table identityiq.spt_yamlconfig (
     id nvarchar(32) not null,
     created numeric(19,0),
     modified numeric(19,0),
     significant_modified numeric(19,0),
     owner nvarchar(32),
     assigned_scope nvarchar(32),
     assigned_scope_path nvarchar(450),
     name nvarchar(128) not null,
     description nvarchar(1024),
     type nvarchar(255),
     subtype nvarchar(255),
     yaml_text nvarchar(max),
     primary key (id)
);
GO
alter table identityiq.spt_yamlconfig
     add constraint UK_7b0o2ht3eii6yl6hlmb901aar unique (name);
GO
alter table identityiq.spt_yamlconfig
     add constraint FKsur3p44hpishjiel9igc33vjk
     foreign key (owner)
     references identityiq.spt_identity;
GO
create index FKsur3p44hpishjiel9igc33vjk on identityiq.spt_yamlconfig (owner);
GO
alter table identityiq.spt_yamlconfig
     add constraint FKfhet5kiyexa0fgx6jj820p6si
     foreign key (assigned_scope)
     references identityiq.spt_scope;
GO
create index FKfhet5kiyexa0fgx6jj820p6si on identityiq.spt_yamlconfig (assigned_scope);
GO
create index SPT_IDX7DB8F9DDEAEFCE0E on identityiq.spt_yamlconfig (assigned_scope_path);
GO

create table identityiq.spt_named_timestamp (
    id nvarchar(32) not null,
    created numeric(19,0),
    modified numeric(19,0),
    significant_modified numeric(19,0),
    name nvarchar(255) not null,
    timestamp numeric(19,0),
    iiqlock nvarchar(128),
    attributes nvarchar(max),
    primary key (id)
);
GO


alter table identityiq.spt_named_timestamp
  add constraint uk_c5tewl8ylk44ns0wx9lik19ae unique (name);
GO

create index spt_intercept_del_extract_ci on identityiq.spt_intercepted_delete (extract_config_name);
GO


--
-- ACCESS HISTORY upgrade begin
--

-- DO NOT REMOVE OR MODIFY BLOCK
-- CONTEXT-SWITCH: dataSourceAccessHistory
-- DO NOT REMOVE OR MODIFY BLOCK

--
-- make sure the identityiqah database and identityiqah user exist.
--

CREATE DATABASE identityiqah
GO
CREATE LOGIN [identityiqah] WITH PASSWORD='identityiqah',
DEFAULT_DATABASE=identityiqah
GO
USE identityiqah
GO
CREATE USER identityiqah FOR LOGIN identityiqah WITH DEFAULT_SCHEMA = identityiqah
GO
CREATE SCHEMA identityiqah AUTHORIZATION identityiqah
GO
grant select,insert,update,delete,create table to identityiqah
GO
EXEC sp_addrolemember 'db_owner', 'identityiqah'
GO
ALTER DATABASE identityiqah SET ALLOW_SNAPSHOT_ISOLATION ON
GO
ALTER DATABASE identityiqah SET READ_COMMITTED_SNAPSHOT ON
GO

create table identityiqah.spt_hist_certification (
     id nvarchar(32) not null,
     created numeric(19,0),
     modified numeric(19,0),
     significant_modified numeric(19,0),
     cert_id nvarchar(32) not null,
     cert_type nvarchar(64),
     cert_display_name nvarchar(128),
     cert_name nvarchar(128),
     finished numeric(19,0),
     signed numeric(19,0),
     json nvarchar(max),
     primary key (id)
);
GO

    create table identityiqah.spt_hist_cert_remediation_capture (
       id nvarchar(32) not null,
        created numeric(19,0),
        modified numeric(19,0),
        significant_modified numeric(19,0),
        patch_doc_parent nvarchar(32),
        identity_id nvarchar(32) not null,
        identity_name nvarchar(128) not null,
        transform_type nvarchar(10) not null,
        effective_date numeric(19,0) not null,
        extended_to_date numeric(19,0),
        json nvarchar(max),
        json_format nvarchar(255),
        smart_hash nvarchar(40),
        full_hash nvarchar(40),
        attributes nvarchar(max),
        certification_item_id nvarchar(32),
        certification_item_type nvarchar(255),
        certification_item_sub_type nvarchar(255),
        exception_application nvarchar(128),
        exception_attribute_name nvarchar(255),
        exception_attribute_value nvarchar(450),
        exception_native_identity nvarchar(322),
        bundle_id nvarchar(32),
        bundle_name nvarchar(128),
        bundle_assignment_id nvarchar(40),
        primary key (id)
    );
    GO

create index spt_patch_doc_parent_cert on identityiqah.spt_hist_cert_remediation_capture (patch_doc_parent);
    GO
create index spt_hist_cert_rem_eff_dt on identityiqah.spt_hist_cert_remediation_capture (effective_date);
    GO
create index spt_hist_cert_rem_ext_dt on identityiqah.spt_hist_cert_remediation_capture (extended_to_date);
    GO
create index spt_hcrc_certitemid on identityiqah.spt_hist_cert_remediation_capture (certification_item_id);
    GO
create index spt_hcrc_certitemtype on identityiqah.spt_hist_cert_remediation_capture (certification_item_type);
    GO
create index spt_hcrc_certitemsubtype on identityiqah.spt_hist_cert_remediation_capture (certification_item_sub_type);
    GO
create index spt_hcrc_exc_app on identityiqah.spt_hist_cert_remediation_capture (exception_application);
    GO
create index spt_hcrc_exc_attrname on identityiqah.spt_hist_cert_remediation_capture (exception_attribute_name);
    GO
create index spt_hcrc_exc_attrval on identityiqah.spt_hist_cert_remediation_capture (exception_attribute_value);
    GO
create index spt_hcrc_nativeIdentity_ci on identityiqah.spt_hist_cert_remediation_capture (exception_native_identity);
    GO
create index spt_hcrc_bundleId on identityiqah.spt_hist_cert_remediation_capture (bundle_id);
    GO
create index spt_hcrc_bundleName on identityiqah.spt_hist_cert_remediation_capture (bundle_name);
    GO
create index spt_hcrc_bundleAssignId on identityiqah.spt_hist_cert_remediation_capture (bundle_assignment_id);
    GO

    create table identityiqah.spt_hist_role_remediation_entitlements (
       cert_remediation_capture nvarchar(32) not null,
        idx int not null,
        application nvarchar(128),
        application_id nvarchar(32),
        entitlement_name nvarchar(255),
        entitlement_value nvarchar(450),
        native_identity nvarchar(322),
        primary key (cert_remediation_capture, idx)
    );
    GO

create index spt_hrre_appname on identityiqah.spt_hist_role_remediation_entitlements (application);
    GO
create index spt_hrre_appid on identityiqah.spt_hist_role_remediation_entitlements (application_id);
    GO
create index spt_hrre_ent_name on identityiqah.spt_hist_role_remediation_entitlements (entitlement_name);
    GO
create index spt_hrre_ent_value on identityiqah.spt_hist_role_remediation_entitlements (entitlement_value);
    GO
create index spt_hrre_native_id on identityiqah.spt_hist_role_remediation_entitlements (native_identity);
    GO
    alter table identityiqah.spt_hist_role_remediation_entitlements
       add constraint FKhvwj97ncucp9u2flf5llenlcs
       foreign key (cert_remediation_capture)
       references identityiqah.spt_hist_cert_remediation_capture;
    GO
    create index FKhvwj97ncucp9u2flf5llenlcs on identityiqah.spt_hist_role_remediation_entitlements (cert_remediation_capture);
    GO


create table identityiqah.spt_hist_identity (
  id nvarchar(32) not null,
  created numeric(19,0),
  modified numeric(19,0),
  significant_modified numeric(19,0),
  identity_id nvarchar(32) not null,
  name nvarchar(128) not null,
  display_name nvarchar(128),
  deleted tinyint,
  lastname nvarchar(128),
  firstname nvarchar(128),
  email nvarchar(128),
  primary key (id)
);
GO

alter table identityiqah.spt_hist_identity
  add constraint spt_hist_identity_name_id_uk unique (identity_id, name);
GO

create index spt_hist_identity_dsp_name_ci on identityiqah.spt_hist_identity (display_name);
GO
create index spt_hist_identity_deleted on identityiqah.spt_hist_identity (deleted);
GO
create index spt_hist_identity_lname_ci on identityiqah.spt_hist_identity (lastname);
GO
create index spt_hist_identity_fname_ci on identityiqah.spt_hist_identity (firstname);
GO
create index spt_hist_identity_email_ci on identityiqah.spt_hist_identity (email);
GO

create table identityiqah.spt_hist_identity_event (
  id nvarchar(32) not null,
  created numeric(19,0),
  modified numeric(19,0),
  significant_modified numeric(19,0),
  entity_id nvarchar(32) not null,
  entity_name nvarchar(128) not null,
  event_date numeric(19,0),
  prev_capture_id nvarchar(32),
  capture_id nvarchar(32),
  event_category nvarchar(255),
  event_type nvarchar(255),
  event_source_type nvarchar(255),
  event_detail_json nvarchar(max),
  property_name nvarchar(255),
  account_id nvarchar(32),
  old_value nvarchar(max),
  new_value nvarchar(max),
  request_item_id nvarchar(32),
  identity_request_id nvarchar(32),
  pending_request_item_id nvarchar(32),
  identity_entitlement_id nvarchar(32),
  acct_app_instance nvarchar(128),
  acct_app_id nvarchar(32),
  acct_native_id nvarchar(255),
  acct_app_name nvarchar(255),
  acct_display_name nvarchar(255),
  qry_property1 nvarchar(255),
  qry_property2 nvarchar(255),
  qry_property3 nvarchar(255),
  qry_property4 nvarchar(255),
  qry_property5 nvarchar(255),
  qry_property6 nvarchar(255),
  qry_property7 nvarchar(255),
  qry_property8 nvarchar(255),
  qry_property9 nvarchar(255),
  qry_property10 nvarchar(255),
  primary key (id)
);
GO

create index spt_hist_ident_event_ent_id on identityiqah.spt_hist_identity_event (entity_id);
GO
create index spt_hist_ident_event_evt_dt on identityiqah.spt_hist_identity_event (event_date);
GO
create index spt_hist_ident_event_evt_cat on identityiqah.spt_hist_identity_event (event_category);
GO
create index spt_hist_ident_event_evt_typ on identityiqah.spt_hist_identity_event (event_type);
GO
create index spt_hist_ident_evt_prp_nm_ci on identityiqah.spt_hist_identity_event (property_name);
GO
create index spt_hist_ident_evt_acct_id on identityiqah.spt_hist_identity_event (account_id);
GO
create index spt_hev_reqitemid on identityiqah.spt_hist_identity_event (request_item_id);
GO
create index spt_hev_reqid on identityiqah.spt_hist_identity_event (identity_request_id);
GO
create index spt_hev_preqitemid on identityiqah.spt_hist_identity_event (pending_request_item_id);
GO
create index spt_hev_entid on identityiqah.spt_hist_identity_event (identity_entitlement_id);
GO
create index spt_hev_appinst_ci on identityiqah.spt_hist_identity_event (acct_app_instance);
GO
create index spt_hist_ident_evt_acct_appid on identityiqah.spt_hist_identity_event (acct_app_id);
GO
create index spt_hist_ident_evt_acct_natid on identityiqah.spt_hist_identity_event (acct_native_id);
GO
create index spt_hie_acct_appname_ci on identityiqah.spt_hist_identity_event (acct_app_name);
GO
create index spt_hie_acct_disp_ci on identityiqah.spt_hist_identity_event (acct_display_name);
GO
create index spt_hist_ident_evt_qry_prop1 on identityiqah.spt_hist_identity_event (qry_property1);
GO
create index spt_hist_ident_evt_qry_prop2 on identityiqah.spt_hist_identity_event (qry_property2);
GO
create index spt_hist_ident_evt_qry_prop3 on identityiqah.spt_hist_identity_event (qry_property3);
GO
create index spt_hist_ident_evt_qry_prop4 on identityiqah.spt_hist_identity_event (qry_property4);
GO
create index spt_hist_ident_evt_qry_prop5 on identityiqah.spt_hist_identity_event (qry_property5);
GO
create index spt_hist_ident_evt_qry_prop6 on identityiqah.spt_hist_identity_event (qry_property6);
GO
create index spt_hist_ident_evt_qry_prop7 on identityiqah.spt_hist_identity_event (qry_property7);
GO
create index spt_hist_ident_evt_qry_prop8 on identityiqah.spt_hist_identity_event (qry_property8);
GO
create index spt_hist_ident_evt_qry_prop9 on identityiqah.spt_hist_identity_event (qry_property9);
GO
create index spt_hist_ident_evt_qry_prop10 on identityiqah.spt_hist_identity_event (qry_property10);
GO

create table identityiqah.spt_hist_identity_capture (
  id nvarchar(32) not null,
  created numeric(19,0),
  modified numeric(19,0),
  significant_modified numeric(19,0),
  patch_doc_parent nvarchar(32),
  identity_id nvarchar(32) not null,
  identity_name nvarchar(128) not null,
  transform_type nvarchar(10) not null,
  effective_date numeric(19,0) not null,
  latest tinyint,
  extended_to_date numeric(19,0),
  json nvarchar(max),
  json_format nvarchar(255),
  smart_hash nvarchar(40),
  full_hash nvarchar(40),
  attributes nvarchar(max),
  manager_id nvarchar(32),
  display_name nvarchar(128),
  firstname nvarchar(128),
  lastname nvarchar(128),
  email nvarchar(128),
  manager_status tinyint,
  inactive tinyint,
  type nvarchar(128),
  primary key (id)
);
GO

create index spt_patch_doc_parent_identity on identityiqah.spt_hist_identity_capture (patch_doc_parent);
GO
create index spt_hist_ident_cap_dpy_nm_ide_id on identityiqah.spt_hist_identity_capture (identity_id, display_name);
GO
create index spt_hist_ident_cap_eff_dt on identityiqah.spt_hist_identity_capture (effective_date);
GO
create index spt_hist_ident_cap_latest on identityiqah.spt_hist_identity_capture (latest);
GO
create index spt_hist_ident_cap_ext_dt on identityiqah.spt_hist_identity_capture (extended_to_date);
GO
create index spt_hist_ident_cap_manager on identityiqah.spt_hist_identity_capture (manager_id);
GO
create index spt_hist_ident_cap_fname_ci on identityiqah.spt_hist_identity_capture (firstname);
GO
create index spt_hist_ident_cap_lname_ci on identityiqah.spt_hist_identity_capture (lastname);
GO
create index spt_hist_ident_cap_email_ci on identityiqah.spt_hist_identity_capture (email);
GO
create index spt_hist_ident_cap_mgr_status on identityiqah.spt_hist_identity_capture (manager_status);
GO
create index spt_hist_ident_cap_inactive on identityiqah.spt_hist_identity_capture (inactive);
GO
create index spt_hist_ident_cap_type_ci on identityiqah.spt_hist_identity_capture (type);
GO

create table identityiqah.spt_hist_role_event (
  id nvarchar(32) not null,
  created numeric(19,0),
  modified numeric(19,0),
  significant_modified numeric(19,0),
  entity_id nvarchar(32) not null,
  entity_name nvarchar(128) not null,
  event_date numeric(19,0),
  prev_capture_id nvarchar(32),
  capture_id nvarchar(32),
  event_category nvarchar(255),
  event_type nvarchar(255),
  event_source_type nvarchar(255),
  event_detail_json nvarchar(max),
  property_name nvarchar(255),
  old_value nvarchar(max),
  new_value nvarchar(max),
  qry_property1 nvarchar(255),
  qry_property2 nvarchar(255),
  qry_property3 nvarchar(255),
  qry_property4 nvarchar(255),
  qry_property5 nvarchar(255),
  qry_property6 nvarchar(255),
  qry_property7 nvarchar(255),
  qry_property8 nvarchar(255),
  qry_property9 nvarchar(255),
  qry_property10 nvarchar(255),
  primary key (id)
);
GO

create index spt_hist_role_event_evt_dt on identityiqah.spt_hist_role_event (event_date);
GO
create index spt_hist_role_event_evt_cat on identityiqah.spt_hist_role_event (event_category);
GO
create index spt_hist_role_event_evt_type on identityiqah.spt_hist_role_event (event_type);
GO
create index spt_hist_role_event_prp_nm_ci on identityiqah.spt_hist_role_event (property_name);
GO
create index spt_hist_role_event_qry_prop1 on identityiqah.spt_hist_role_event (qry_property1);
GO
create index spt_hist_role_event_qry_prop2 on identityiqah.spt_hist_role_event (qry_property2);
GO
create index spt_hist_role_event_qry_prop3 on identityiqah.spt_hist_role_event (qry_property3);
GO
create index spt_hist_role_event_qry_prop4 on identityiqah.spt_hist_role_event (qry_property4);
GO
create index spt_hist_role_event_qry_prop5 on identityiqah.spt_hist_role_event (qry_property5);
GO
create index spt_hist_role_event_qry_prop6 on identityiqah.spt_hist_role_event (qry_property6);
GO
create index spt_hist_role_event_qry_prop7 on identityiqah.spt_hist_role_event (qry_property7);
GO
create index spt_hist_role_event_qry_prop8 on identityiqah.spt_hist_role_event (qry_property8);
GO
create index spt_hist_role_event_qry_prop9 on identityiqah.spt_hist_role_event (qry_property9);
GO
create index spt_hist_role_evt_qry_prop10 on identityiqah.spt_hist_role_event (qry_property10);
GO

alter table identityiqah.spt_hist_certification
     add constraint uk_kesw6k26csy7qxitgtloos7y2 unique (cert_id);
GO

    create table identityiqah.spt_hist_identity_req_capture (
       id nvarchar(32) not null,
        created numeric(19,0),
        modified numeric(19,0),
        significant_modified numeric(19,0),
        patch_doc_parent nvarchar(32),
        identity_id nvarchar(32) not null,
        identity_name nvarchar(128) not null,
        transform_type nvarchar(10) not null,
        effective_date numeric(19,0) not null,
        extended_to_date numeric(19,0),
        json nvarchar(max),
        json_format nvarchar(255),
        smart_hash nvarchar(40),
        full_hash nvarchar(40),
        deleted tinyint,
        attributes nvarchar(max),
        identity_request_id nvarchar(32),
        type nvarchar(128),
        end_date numeric(19,0),
        requester_id nvarchar(32),
        requester_display_name nvarchar(255),
        primary key (id)
    );
    GO

create index spt_patch_doc_parent_idreq on identityiqah.spt_hist_identity_req_capture (patch_doc_parent);
    GO
create index spt_hist_idreq_eff_dt on identityiqah.spt_hist_identity_req_capture (effective_date);
    GO
create index spt_hist_idreq_ext_dt on identityiqah.spt_hist_identity_req_capture (extended_to_date);
    GO
create index spt_hist_idreq_deleted on identityiqah.spt_hist_identity_req_capture (deleted);
    GO
create index spt_hist_idreq_id on identityiqah.spt_hist_identity_req_capture (identity_request_id);
    GO
create index spt_hist_idreq_type_ci on identityiqah.spt_hist_identity_req_capture (type);
    GO
create index spt_hist_idreq_end_dt on identityiqah.spt_hist_identity_req_capture (end_date);
    GO
create index spt_hist_idreq_reqr_id on identityiqah.spt_hist_identity_req_capture (requester_id);
    GO
create index spt_hist_idreq_reqr_name_ci on identityiqah.spt_hist_identity_req_capture (requester_display_name);
    GO


    create table identityiqah.spt_hist_identity_req_item_capture (
       id nvarchar(32) not null,
        created numeric(19,0),
        modified numeric(19,0),
        significant_modified numeric(19,0),
        patch_doc_parent nvarchar(32),
        transform_type nvarchar(10) not null,
        effective_date numeric(19,0) not null,
        extended_to_date numeric(19,0),
        json nvarchar(max),
        json_format nvarchar(255),
        smart_hash nvarchar(40),
        full_hash nvarchar(40),
        identity_id nvarchar(32) not null,
        identity_name nvarchar(128) not null,
        identity_entitlement_id nvarchar(32),
        deleted tinyint,
        attributes nvarchar(max),
        native_identity nvarchar(450),
        name nvarchar(255),
        value nvarchar(450),
        identity_request_item_id nvarchar(32),
        identity_request_id nvarchar(32),
        type nvarchar(128),
        application_name nvarchar(128),
        operation nvarchar(128),
        owner_name nvarchar(128),
        approver_name nvarchar(128),
        requester_name nvarchar(128),
        requester_id nvarchar(32),
        assignment_id nvarchar(40),
        provisioning_state nvarchar(128),
        approval_state nvarchar(128),
        compilation_status nvarchar(128),
        identity_request_capture_id nvarchar(32),
        idx int,
        primary key (id)
    );
    GO

create index spt_patch_doc_parent_reqitem on identityiqah.spt_hist_identity_req_item_capture (patch_doc_parent);
    GO
create index spt_hist_idri_eff_dt on identityiqah.spt_hist_identity_req_item_capture (effective_date);
    GO
create index spt_hist_idri_ext_dt on identityiqah.spt_hist_identity_req_item_capture (extended_to_date);
    GO
create index spt_hist_idri_iid on identityiqah.spt_hist_identity_req_item_capture (identity_id);
    GO
create index spt_hist_idri_iname_ci on identityiqah.spt_hist_identity_req_item_capture (identity_name);
    GO
create index spt_hist_idri_ieid on identityiqah.spt_hist_identity_req_item_capture (identity_entitlement_id);
    GO
create index spt_hist_idri_deleted on identityiqah.spt_hist_identity_req_item_capture (deleted);
    GO
create index spt_hist_idri_nativeid_ci on identityiqah.spt_hist_identity_req_item_capture (native_identity);
    GO
create index spt_hist_idri_name_ci on identityiqah.spt_hist_identity_req_item_capture (name);
    GO
create index spt_hist_idri_value_ci on identityiqah.spt_hist_identity_req_item_capture (value);
    GO
create index spt_hist_idri_iri_id on identityiqah.spt_hist_identity_req_item_capture (identity_request_item_id);
    GO
create index spt_hist_idri_ir_id on identityiqah.spt_hist_identity_req_item_capture (identity_request_id);
    GO
create index spt_hist_idri_type_ci on identityiqah.spt_hist_identity_req_item_capture (type);
    GO
create index spt_hist_idri_appName_ci on identityiqah.spt_hist_identity_req_item_capture (application_name);
    GO
create index spt_hist_idri_ownername_ci on identityiqah.spt_hist_identity_req_item_capture (owner_name);
    GO
create index spt_hist_idri_approvername_ci on identityiqah.spt_hist_identity_req_item_capture (approver_name);
    GO
create index spt_hist_idri_reqname_ci on identityiqah.spt_hist_identity_req_item_capture (requester_name);
    GO
create index spt_hist_idri_reqid on identityiqah.spt_hist_identity_req_item_capture (requester_id);
    GO
create index spt_hist_idri_assgid on identityiqah.spt_hist_identity_req_item_capture (assignment_id);
    GO
create index spt_hist_idri_pstate on identityiqah.spt_hist_identity_req_item_capture (provisioning_state);
    GO
create index spt_hist_idri_astate on identityiqah.spt_hist_identity_req_item_capture (approval_state);
    GO
create index spt_hist_idri_compStat on identityiqah.spt_hist_identity_req_item_capture (compilation_status);
    GO

    alter table identityiqah.spt_hist_identity_req_item_capture
       add constraint FK6dn4yl1mqiub2ejxsgms1vex8
       foreign key (identity_request_capture_id)
       references identityiqah.spt_hist_identity_req_capture;
    GO

    create index FK6dn4yl1mqiub2ejxsgms1vex8 on identityiqah.spt_hist_identity_req_item_capture (identity_request_capture_id);
    GO 

create table identityiqah.spt_hist_mattr (
   id nvarchar(32) not null,
   created numeric(19,0),
   modified numeric(19,0),
   significant_modified numeric(19,0),
   mattr_id nvarchar(32) not null,
   mattr_hash nvarchar(128) not null,
   display_name nvarchar(128),
   deleted tinyint,
   primary key (id)
);
GO

alter table identityiqah.spt_hist_mattr
  add constraint UK_sgmfjmeagljgj36cgi3o0cltw unique (mattr_id);
GO

create index spt_hist_mattr_displayName_ci on identityiqah.spt_hist_mattr (display_name);
GO
create index spt_hist_mattr_deleted on identityiqah.spt_hist_mattr (deleted);
GO

create table identityiqah.spt_hist_mattr_capture (
  id nvarchar(32) not null,
  created numeric(19,0),
  modified numeric(19,0),
  significant_modified numeric(19,0),
  patch_doc_parent nvarchar(32),
  transform_type nvarchar(10) not null,
  effective_date numeric(19,0) not null,
  extended_to_date numeric(19,0),
  json nvarchar(max),
  json_format nvarchar(255),
  smart_hash nvarchar(40),
  full_hash nvarchar(40),
  attributes nvarchar(max),
  mattr_id nvarchar(32) not null,
  mattr_hash nvarchar(128) not null,
  display_name nvarchar(128),
  application_name nvarchar(128),
  application_id nvarchar(32),
  type nvarchar(128),
  attribute_name nvarchar(255),
  attribute_value nvarchar(450),
  primary key (id)
);
GO

create index spt_patch_doc_parent_mattr on identityiqah.spt_hist_mattr_capture (patch_doc_parent);
    GO
create index spt_hist_mattr_cap_eff_dt on identityiqah.spt_hist_mattr_capture (effective_date);
    GO
create index spt_hist_mattr_cap_ext_dt on identityiqah.spt_hist_mattr_capture (extended_to_date);
    GO
create index spt_hist_matt_cap_matt_id on identityiqah.spt_hist_mattr_capture (mattr_id);
    GO
create index spt_hist_matt_cap_matt_hsh_ci on identityiqah.spt_hist_mattr_capture (mattr_hash);
    GO
create index spt_hist_mattr_cap_dsp_nm_ci on identityiqah.spt_hist_mattr_capture (display_name);
    GO
create index spt_mac_appname_ci on identityiqah.spt_hist_mattr_capture (application_name);
    GO
create index spt_mac_appid on identityiqah.spt_hist_mattr_capture (application_id);
    GO
create index spt_mac_type_ci on identityiqah.spt_hist_mattr_capture (type);
    GO
create index spt_mac_attr_ci on identityiqah.spt_hist_mattr_capture (attribute_name);
    GO
create index spt_mac_value_ci on identityiqah.spt_hist_mattr_capture (attribute_value);
    GO

create table identityiqah.spt_hist_mattr_event (
  id nvarchar(32) not null,
  created numeric(19,0),
  modified numeric(19,0),
  significant_modified numeric(19,0),
  entity_id nvarchar(32) not null,
  display_name nvarchar(128),
  event_date numeric(19,0),
  prev_capture_id nvarchar(32),
  capture_id nvarchar(32),
  event_category nvarchar(255),
  event_type nvarchar(255),
  event_source_type nvarchar(255),
  event_detail_json nvarchar(max),
  property_name nvarchar(255),
  old_value nvarchar(max),
  new_value nvarchar(max),
  acct_app_id nvarchar(32),
  acct_native_id nvarchar(255),
  acct_app_name nvarchar(255),
  acct_display_name nvarchar(255),
  qry_property1 nvarchar(255),
  qry_property2 nvarchar(255),
  qry_property3 nvarchar(255),
  qry_property4 nvarchar(255),
  qry_property5 nvarchar(255),
  qry_property6 nvarchar(255),
  qry_property7 nvarchar(255),
  qry_property8 nvarchar(255),
  qry_property9 nvarchar(255),
  qry_property10 nvarchar(255),
  primary key (id)
);
GO

create index spt_hist_mattr_evt_dsp_nm_ci on identityiqah.spt_hist_mattr_event (display_name);
GO
create index spt_hist_mattr_event_evt_dt on identityiqah.spt_hist_mattr_event (event_date);
GO
create index spt_hist_mattr_event_evt_cat on identityiqah.spt_hist_mattr_event (event_category);
GO
create index spt_hist_mattr_event_evt_type on identityiqah.spt_hist_mattr_event (event_type);
GO
create index spt_hist_mattr_evt_prp_nm_ci on identityiqah.spt_hist_mattr_event (property_name);
GO
create index spt_hist_mattr_evt_acct_appid on identityiqah.spt_hist_mattr_event (acct_app_id);
GO
create index spt_hist_mattr_evt_nativeid on identityiqah.spt_hist_mattr_event (acct_native_id);
GO
create index spt_hmae_acct_appname_ci on identityiqah.spt_hist_mattr_event (acct_app_name);
GO
create index spt_hmae_acct_disp_ci on identityiqah.spt_hist_mattr_event (acct_display_name);
GO
create index spt_hist_mattr_evt_qry_prop1 on identityiqah.spt_hist_mattr_event (qry_property1);
GO
create index spt_hist_mattr_evt_qry_prop2 on identityiqah.spt_hist_mattr_event (qry_property2);
GO
create index spt_hist_mattr_evt_qry_prop3 on identityiqah.spt_hist_mattr_event (qry_property3);
GO
create index spt_hist_mattr_evt_qry_prop4 on identityiqah.spt_hist_mattr_event (qry_property4);
GO
create index spt_hist_mattr_evt_qry_prop5 on identityiqah.spt_hist_mattr_event (qry_property5);
GO
create index spt_hist_mattr_evt_qry_prop6 on identityiqah.spt_hist_mattr_event (qry_property6);
GO
create index spt_hist_mattr_evt_qry_prop7 on identityiqah.spt_hist_mattr_event (qry_property7);
GO
create index spt_hist_mattr_evt_qry_prop8 on identityiqah.spt_hist_mattr_event (qry_property8);
GO
create index spt_hist_mattr_evt_qry_prop9 on identityiqah.spt_hist_mattr_event (qry_property9);
GO
create index spt_hist_mattr_evt_qry_prop10 on identityiqah.spt_hist_mattr_event (qry_property10);
GO

create table identityiqah.spt_hist_role (
  id nvarchar(32) not null,
  created numeric(19,0),
  modified numeric(19,0),
  significant_modified numeric(19,0),
  role_id nvarchar(32) not null,
  name nvarchar(128) not null,
  display_name nvarchar(128),
  deleted tinyint,
  primary key (id)
);
GO

create table identityiqah.spt_hist_role_capture (
  id nvarchar(32) not null,
  created numeric(19,0),
  modified numeric(19,0),
  significant_modified numeric(19,0),
  patch_doc_parent nvarchar(32),
  role_id nvarchar(32) not null,
  role_name nvarchar(128) not null,
  transform_type nvarchar(10) not null,
  effective_date numeric(19,0) not null,
  extended_to_date numeric(19,0),
  json nvarchar(max),
  json_format nvarchar(255),
  smart_hash nvarchar(40),
  full_hash nvarchar(40),
  attributes nvarchar(max),
  type nvarchar(128),
  owner_id nvarchar(32),
  primary key (id)
);
GO

create index spt_patch_doc_parent_role on identityiqah.spt_hist_role_capture (patch_doc_parent);
GO
create index spt_hist_role_cap_eff_dt on identityiqah.spt_hist_role_capture (effective_date);
GO
create index spt_hist_role_cap_ext_dt on identityiqah.spt_hist_role_capture (extended_to_date);
GO
create index spt_hrc_type_ci on identityiqah.spt_hist_role_capture (type);
GO
create index spt_hrc_ownerid on identityiqah.spt_hist_role_capture (owner_id);
GO

create index spt_hist_role_displayname_ci on identityiqah.spt_hist_role (display_name);
GO

create index spt_hist_role_deleted on identityiqah.spt_hist_role (deleted);
GO

alter table identityiqah.spt_hist_role
  add constraint uk_kem9ulqu2gybfqdtq226k3htc unique (role_id);
GO

create table identityiqah.spt_hist_capability (
  id nvarchar(32) not null,
  created numeric(19,0),
  modified numeric(19,0),
  significant_modified numeric(19,0),
  name nvarchar(128) not null,
  description nvarchar(1024),
  capability_id nvarchar(32) not null,
  display_name nvarchar(128),
  deleted tinyint,
  primary key (id)
);
GO

create index spt_hist_cap_displayname_ci on identityiqah.spt_hist_capability (display_name);
GO
create index spt_hist_capability_deleted on identityiqah.spt_hist_capability (deleted);
GO
alter table identityiqah.spt_hist_capability
  add constraint uk_q19cl120ixe3opavvwxoi0ahu unique (capability_id);
GO

create table identityiqah.spt_hist_capability_capture (
  id nvarchar(32) not null,
  created numeric(19,0),
  modified numeric(19,0),
  significant_modified numeric(19,0),
  patch_doc_parent nvarchar(32),
  capability_id nvarchar(32) not null,
  capability_name nvarchar(128) not null,
  transform_type nvarchar(10) not null,
  effective_date numeric(19,0) not null,
  extended_to_date numeric(19,0),
  json nvarchar(max),
  json_format nvarchar(255),
  smart_hash nvarchar(40),
  full_hash nvarchar(40),
  attributes nvarchar(max),
  primary key (id)
);
GO

create index spt_patch_doc_parent_cap on identityiqah.spt_hist_capability_capture (patch_doc_parent);
GO
create index spt_hist_cap_capture_eff_dt on identityiqah.spt_hist_capability_capture (effective_date);
GO
create index spt_hist_cap_capture_ext_dt on identityiqah.spt_hist_capability_capture (extended_to_date);
GO

create table identityiqah.spt_hist_assigned_roles (
   capture_id nvarchar(32) not null,
   idx int not null,
   role_id nvarchar(255),
   primary key (capture_id, idx)
);
GO

create table identityiqah.spt_hist_detected_roles (
   capture_id nvarchar(32) not null,
   idx int not null,
   role_id nvarchar(255),
   primary key (capture_id, idx)
);
GO

alter table identityiqah.spt_hist_assigned_roles
   add constraint FK57arq9l8c10fbrtbixsryavgg
   foreign key (capture_id)
   references identityiqah.spt_hist_identity_capture;
GO

create index FK57arq9l8c10fbrtbixsryavgg on identityiqah.spt_hist_assigned_roles (capture_id);
GO

alter table identityiqah.spt_hist_detected_roles
  add constraint FKsvem4m5n0f7dqasy8pht1m0dj
  foreign key (capture_id)
  references identityiqah.spt_hist_identity_capture;
GO

create index FKsvem4m5n0f7dqasy8pht1m0dj on identityiqah.spt_hist_detected_roles (capture_id);
GO

create table identityiqah.spt_hist_entitlement_capture (
   id nvarchar(32) not null,
   created numeric(19,0),
   modified numeric(19,0),
   significant_modified numeric(19,0),
   patch_doc_parent nvarchar(32),
   identity_id nvarchar(32) not null,
   identity_name nvarchar(128) not null,
   transform_type nvarchar(10) not null,
   effective_date numeric(19,0) not null,
   extended_to_date numeric(19,0),
   json nvarchar(max),
   json_format nvarchar(255),
   smart_hash nvarchar(40),
   full_hash nvarchar(40),
   attributes nvarchar(max),
   identity_entitlement_id nvarchar(32),
   application_id nvarchar(32),
   application_name nvarchar(128),
   native_identity nvarchar(450),
   instance nvarchar(128),
   display_value nvarchar(450),
   type nvarchar(128),
   attribute_name nvarchar(255),
   attribute_value nvarchar(450),
   granted_by_role tinyint,
   role_id nvarchar(32),
   request_item_id nvarchar(32),
   pending_request_item_id nvarchar(32),
   certification_item_id nvarchar(32),
   deleted tinyint,
   primary key (id)
);
GO

create index spt_patch_doc_parent_entl on identityiqah.spt_hist_entitlement_capture (patch_doc_parent);
GO
create index spt_hist_identity_cap_eff_dt on identityiqah.spt_hist_entitlement_capture (effective_date);
GO
create index spt_hist_identity_cap_ext_dt on identityiqah.spt_hist_entitlement_capture (extended_to_date);
GO
create index spt_hec_ie_id on identityiqah.spt_hist_entitlement_capture (identity_entitlement_id);
GO
create index spt_hec_appid on identityiqah.spt_hist_entitlement_capture (application_id);
GO
create index spt_hec_app_role_type on identityiqah.spt_hist_entitlement_capture (application_name, type, attribute_name);
GO
create index spt_hec_appName_ci on identityiqah.spt_hist_entitlement_capture (application_name);
GO
create index spt_hec_nativeid_ci on identityiqah.spt_hist_entitlement_capture (native_identity);
GO
create index spt_hec_instance_ci on identityiqah.spt_hist_entitlement_capture (instance);
GO
create index spt_hec_dispValue_ci on identityiqah.spt_hist_entitlement_capture (display_value);
GO
create index spt_hec_type_ci on identityiqah.spt_hist_entitlement_capture (type);
GO
create index spt_hec_attrname_ci on identityiqah.spt_hist_entitlement_capture (attribute_name);
GO
create index spt_hec_attrvalue_ci on identityiqah.spt_hist_entitlement_capture (attribute_value);
GO
create index spt_hist_hec_by_role on identityiqah.spt_hist_entitlement_capture (granted_by_role);
GO
create index spt_hec_roleid on identityiqah.spt_hist_entitlement_capture (role_id);
GO
create index spt_hec_reqitemid on identityiqah.spt_hist_entitlement_capture (request_item_id);
GO
create index spt_hec_preqitemid on identityiqah.spt_hist_entitlement_capture (pending_request_item_id);
GO
create index spt_hec_certitemid on identityiqah.spt_hist_entitlement_capture (certification_item_id);
GO
create index spt_hec_deleted on identityiqah.spt_hist_entitlement_capture (deleted);
GO

create table identityiqah.spt_hist_entitlements (
   capture_id nvarchar(32) not null,
    idx int not null,
    identity_entitlement_id nvarchar(255),
    primary key (capture_id, idx)
);
GO

alter table identityiqah.spt_hist_entitlements
   add constraint FKslsba39xq240608yr2vc59rn3
   foreign key (capture_id)
   references identityiqah.spt_hist_identity_capture;
GO
create index FKslsba39xq240608yr2vc59rn3 on identityiqah.spt_hist_entitlements (capture_id);
GO

create table identityiqah.spt_hist_workgroup (
    id nvarchar(32) not null,
    created numeric(19,0),
    modified numeric(19,0),
    significant_modified numeric(19,0),
    workgroup_id nvarchar(32) not null,
    name nvarchar(128) not null,
    display_name nvarchar(128),
    description nvarchar(1024),
    deleted tinyint,
    email nvarchar(128),
    primary key (id)
);
GO

create table identityiqah.spt_hist_policy_violations (
     capture_id nvarchar(32) not null,
     idx int not null,
     policy_violation_id nvarchar(255),
     primary key (capture_id, idx)
);
GO

create table identityiqah.spt_hist_policy_violation_capture (
     id nvarchar(32) not null,
     created numeric(19,0),
     modified numeric(19,0),
     significant_modified numeric(19,0),
     patch_doc_parent nvarchar(32),
     identity_id nvarchar(32) not null,
     identity_name nvarchar(128) not null,
     transform_type nvarchar(10) not null,
     effective_date numeric(19,0) not null,
     extended_to_date numeric(19,0),
     json nvarchar(max),
     json_format nvarchar(255),
     smart_hash nvarchar(40),
     full_hash nvarchar(40),
     attributes nvarchar(max),
     policy_violation_id nvarchar(32),
     active tinyint,
     policy_id nvarchar(255),
     policy_name nvarchar(255),
     constraint_id nvarchar(255),
     constraint_name nvarchar(255),
     status nvarchar(255),
     deleted tinyint,
     primary key (id)
);
GO

create index spt_patch_doc_parent_pv on identityiqah.spt_hist_policy_violation_capture (patch_doc_parent);
GO
create index spt_hist_pv_cap_eff_dt on identityiqah.spt_hist_policy_violation_capture (effective_date);
GO
create index spt_hist_pv_cap_ext_dt on identityiqah.spt_hist_policy_violation_capture (extended_to_date);
GO
create index spt_hist_pv_id on identityiqah.spt_hist_policy_violation_capture (policy_violation_id);
GO
create index spt_hist_pv_active on identityiqah.spt_hist_policy_violation_capture (active);
GO
create index spt_hist_pv_deleted on identityiqah.spt_hist_policy_violation_capture (deleted);
GO

alter table identityiqah.spt_hist_policy_violations
     add constraint FK431cy516ss4k08rgrpq20x1wb
     foreign key (capture_id)
     references identityiqah.spt_hist_identity_capture;
GO

create index FK431cy516ss4k08rgrpq20x1wb on identityiqah.spt_hist_policy_violations (capture_id);
GO

create table identityiqah.spt_hist_policy_violation_remediation_capture (
    id nvarchar(32) not null,
    created numeric(19,0),
    modified numeric(19,0),
    significant_modified numeric(19,0),
    patch_doc_parent nvarchar(32),
    identity_id nvarchar(32) not null,
    identity_name nvarchar(128) not null,
    transform_type nvarchar(10) not null,
    effective_date numeric(19,0) not null,
    extended_to_date numeric(19,0),
    json nvarchar(max),
    json_format nvarchar(255),
    smart_hash nvarchar(40),
    full_hash nvarchar(40),
    attributes nvarchar(max),
    identity_history_item_id nvarchar(32),
    certification_item_type nvarchar(255),
    policy_name nvarchar(255),
    constraint_name nvarchar(255),
    deleted tinyint,
    primary key (id)
);
GO

create index spt_patch_doc_parent_pvr on identityiqah.spt_hist_policy_violation_remediation_capture (patch_doc_parent);
GO
create index spt_hist_pvr_cap_eff_dt on identityiqah.spt_hist_policy_violation_remediation_capture (effective_date);
GO
create index spt_hist_pvr_cap_ext_dt on identityiqah.spt_hist_policy_violation_remediation_capture (extended_to_date);
GO
create index spt_pvr_cap_ihiid on identityiqah.spt_hist_policy_violation_remediation_capture (identity_history_item_id);
GO
create index spt_pvr_cap_certitemtype on identityiqah.spt_hist_policy_violation_remediation_capture (certification_item_type);
GO

create table identityiqah.spt_hist_policy_violation_remediation_bundle_ids (
    capture_id nvarchar(32) not null,
    idx int not null,
    bundle_id nvarchar(255),
    primary key (capture_id, idx)
);
GO

alter table identityiqah.spt_hist_policy_violation_remediation_bundle_ids
    add constraint FKitaxnoflkhnq6ijo5yqmh29jc
    foreign key (capture_id)
    references identityiqah.spt_hist_policy_violation_remediation_capture;
GO

create index FKitaxnoflkhnq6ijo5yqmh29jc on identityiqah.spt_hist_policy_violation_remediation_bundle_ids (capture_id);
GO

create table identityiqah.spt_hist_policy_violation_remediation_entitlements (
    policy_violation_remediation_ent nvarchar(32) not null,
    idx int not null,
    application nvarchar(255),
    application_id nvarchar(255),
    entitlement_name nvarchar(255),
    entitlement_value nvarchar(255),
    entitlement_display_value nvarchar(255),
    primary key (policy_violation_remediation_ent, idx)
);
GO

alter table identityiqah.spt_hist_policy_violation_remediation_entitlements
    add constraint fkjie8pn4nfhcfi3t92br291fc1
    foreign key (policy_violation_remediation_ent)
    references identityiqah.spt_hist_policy_violation_remediation_capture;
GO

create index fkjie8pn4nfhcfi3t92br291fc1 on identityiqah.spt_hist_policy_violation_remediation_entitlements (policy_violation_remediation_ent);
GO

create table identityiqah.spt_hist_accounts (
    capture_id nvarchar(32) not null,
    idx int not null,
    account_id nvarchar(255),
    primary key (capture_id, idx)
);
GO

create table identityiqah.spt_hist_account_capture (
    id nvarchar(32) not null,
    created numeric(19,0),
    modified numeric(19,0),
    significant_modified numeric(19,0),
    patch_doc_parent nvarchar(32),
    identity_id nvarchar(32) not null,
    identity_name nvarchar(128) not null,
    transform_type nvarchar(10) not null,
    effective_date numeric(19,0) not null,
    extended_to_date numeric(19,0),
    json nvarchar(max),
    json_format nvarchar(255),
    smart_hash nvarchar(40),
    full_hash nvarchar(40),
    attributes nvarchar(max),
    account_id nvarchar(32),
    application_name nvarchar(128),
    displayable_name nvarchar(128),
    deleted tinyint,
    primary key (id)
);
GO

create index spt_patch_doc_parent_account on identityiqah.spt_hist_account_capture (patch_doc_parent);
GO
create index spt_hac_account_cap_eff_dt on identityiqah.spt_hist_account_capture (effective_date);
GO
create index spt_hac_account_cap_ext_dt on identityiqah.spt_hist_account_capture (extended_to_date);
GO
create index spt_hac_account_id on identityiqah.spt_hist_account_capture (account_id);
GO
create index spt_hac_account_dn_ci on identityiqah.spt_hist_account_capture (displayable_name);
GO
create index spt_hac_account_deleted on identityiqah.spt_hist_account_capture (deleted);
GO

alter table identityiqah.spt_hist_accounts
    add constraint fk605klb45cwnh86urs1aw07cue
    foreign key (capture_id)
    references identityiqah.spt_hist_identity_capture;
GO

create index fk605klb45cwnh86urs1aw07cue on identityiqah.spt_hist_accounts (capture_id);
GO

create table identityiqah.spt_hist_workgroup_capture (
    id nvarchar(32) not null,
    created numeric(19,0),
    modified numeric(19,0),
    significant_modified numeric(19,0),
    patch_doc_parent nvarchar(32),
    workgroup_id nvarchar(32) not null,
    workgroup_name nvarchar(128) not null,
    transform_type nvarchar(10) not null,
    effective_date numeric(19,0) not null,
    extended_to_date numeric(19,0),
    json nvarchar(max),
    json_format nvarchar(255),
    smart_hash nvarchar(40),
    full_hash nvarchar(40),
    attributes nvarchar(max),
    display_name nvarchar(128),
    email nvarchar(128),
    inactive tinyint,
    primary key (id)
);
GO

create table identityiqah.spt_hist_workgroup_event (
    id nvarchar(32) not null,
    created numeric(19,0),
    modified numeric(19,0),
    significant_modified numeric(19,0),
    entity_id nvarchar(32) not null,
    entity_name nvarchar(128) not null,
    event_date numeric(19,0),
    prev_capture_id nvarchar(32),
    capture_id nvarchar(32),
    event_category nvarchar(255),
    event_type nvarchar(255),
    event_source_type nvarchar(255),
    event_detail_json nvarchar(max),
    property_name nvarchar(255),
    old_value nvarchar(max),
    new_value nvarchar(max),
    qry_property1 nvarchar(255),
    qry_property2 nvarchar(255),
    qry_property3 nvarchar(255),
    qry_property4 nvarchar(255),
    qry_property5 nvarchar(255),
    qry_property6 nvarchar(255),
    qry_property7 nvarchar(255),
    qry_property8 nvarchar(255),
    qry_property9 nvarchar(255),
    qry_property10 nvarchar(255),
    primary key (id)
);
GO

create index spt_hist_wg_displayname_ci on identityiqah.spt_hist_workgroup (display_name);
GO
create index spt_hist_wg_deleted on identityiqah.spt_hist_workgroup (deleted);
GO
create index spt_hist_wg_email_ci on identityiqah.spt_hist_workgroup (email);
GO

alter table identityiqah.spt_hist_workgroup
     add constraint spt_hist_wg_name_id_uk unique (workgroup_id, name);
GO

create index spt_patch_doc_parent_workgroup on identityiqah.spt_hist_workgroup_capture (patch_doc_parent);
GO
create index spt_hist_workgroup_cap_eff_dt on identityiqah.spt_hist_workgroup_capture (effective_date);
GO
create index spt_hist_workgroup_cap_ext_dt on identityiqah.spt_hist_workgroup_capture (extended_to_date);
GO
create index spt_hwc_displayname_ci on identityiqah.spt_hist_workgroup_capture (display_name);
GO
create index spt_hwc_email_ci on identityiqah.spt_hist_workgroup_capture (email);
GO
create index spt_hwc_inactive on identityiqah.spt_hist_workgroup_capture (inactive);
GO
create index spt_hist_wg_evt_evt_dt on identityiqah.spt_hist_workgroup_event (event_date);
GO
create index spt_hist_wg_evt_evt_cat on identityiqah.spt_hist_workgroup_event (event_category);
GO
create index spt_hist_wg_evt_evt_type on identityiqah.spt_hist_workgroup_event (event_type);
GO
create index spt_hist_wg_evt_prp_nm_ci on identityiqah.spt_hist_workgroup_event (property_name);
GO
create index spt_hist_wg_evt_qry_prop1 on identityiqah.spt_hist_workgroup_event (qry_property1);
GO
create index spt_hist_wg_evt_qry_prop2 on identityiqah.spt_hist_workgroup_event (qry_property2);
GO
create index spt_hist_wg_evt_qry_prop3 on identityiqah.spt_hist_workgroup_event (qry_property3);
GO
create index spt_hist_wg_evt_qry_prop4 on identityiqah.spt_hist_workgroup_event (qry_property4);
GO
create index spt_hist_wg_evt_qry_prop5 on identityiqah.spt_hist_workgroup_event (qry_property5);
GO
create index spt_hist_wg_evt_qry_prop6 on identityiqah.spt_hist_workgroup_event (qry_property6);
GO
create index spt_hist_wg_evt_qry_prop7 on identityiqah.spt_hist_workgroup_event (qry_property7);
GO
create index spt_hist_wg_evt_qry_prop8 on identityiqah.spt_hist_workgroup_event (qry_property8);
GO
create index spt_hist_wg_evt_qry_prop9 on identityiqah.spt_hist_workgroup_event (qry_property9);
GO
create index spt_hist_wg_evt_qry_prop10 on identityiqah.spt_hist_workgroup_event (qry_property10);
GO


create table identityiqah.spt_hist_object_config_capture (
    id nvarchar(32) not null,
    created numeric(19,0),
    modified numeric(19,0),
    significant_modified numeric(19,0),
    patch_doc_parent nvarchar(32),
    object_config_id nvarchar(32) not null,
    object_config_name nvarchar(128) not null,
    transform_type nvarchar(10) not null,
    effective_date numeric(19,0) not null,
    extended_to_date numeric(19,0),
    json nvarchar(max),
    json_format nvarchar(255),
    smart_hash nvarchar(40),
    full_hash nvarchar(40),
    primary key (id)
);
GO

create index spt_hist_oc_patch_doc_parent on identityiqah.spt_hist_object_config_capture (patch_doc_parent);
GO
create index spt_hist_oc_cap_eff_dt on identityiqah.spt_hist_object_config_capture (effective_date);
GO
create index spt_hist_oc_cap_ext_dt on identityiqah.spt_hist_object_config_capture (extended_to_date);
GO

create table identityiqah.spt_hist_database_version (
    name nvarchar(255) not null,
    system_version nvarchar(128),
    schema_version nvarchar(128),
    primary key (name)
);
GO

--
-- This is necessary to maintain the schema version. DO NOT REMOVE.
--
insert into identityiqah.spt_hist_database_version (system_version,name) values ('8.4-00','main');
GO
update identityiqah.spt_hist_database_version set schema_version='8.4-87' where name='main';
GO

--
-- ACCESS HISTORY upgrade end
--

--
-- This is necessary to maintain the schema version. DO NOT REMOVE.
--

-- DO NOT REMOVE OR MODIFY BLOCK
-- CONTEXT-SWITCH: dataSource
-- DO NOT REMOVE OR MODIFY BLOCK

USE identityiq
GO
update identityiq.spt_database_version set schema_version='8.4-87' where name='main';
GO
